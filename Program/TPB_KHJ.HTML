<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="text/javascript">
    window.addEventListener('load', init, false);
    function init()
    {
        //document.addEventListener('keypress', onKeyPressFunc(event), false);
        document.onkeydown = onKeyDownFunc;
        document.onkeyup = onKeyUpFunc;
        document.onmousemove = onMouseMoveFunc;
        var Canvas = document.getElementById('canvas');
        var Context = Canvas.getContext('2d');
        document.getElementById('container').style.left = window.innerWidth / 2 - 400 + 'px';

        var frame = 60;
        var deltaTime = 1 / frame;

        var System = {Game: 0, Pause: 0, Life: 2, Bomb: 1}

        var Objects = new Array();
        var Player = { type: "player", x: 400, y: 300, angle: 0, speed: 50, size: 8, dx: 0, dy: 0 };
        var Cursor = { type: "player", x: 0, y: 0, angle: 0, size: 10}
        var Enemies = new Array();
        var Pbullet = new Array();
        var Ebullet = new Array();

        var numBalls = 10;
        var tempBall;
        for (var i = 0; i < numBalls; i++)
        {
            var tempAngle = Math.floor(Math.random() * 360);
            tempBall = { type: "etc", x: 100, y: 100, angle: tempAngle, speed: 20, size: 5, dx: 0, dy: 0, bs: 0}
            Ebullet.push(tempBall);
        }

        setInterval(update, deltaTime);
        function update()
        {
            draw();
            //collision
            //stat
        }

        function draw()
        {
            //Canvas
            Context.fillStyle = '#CCCCCC';
            Context.fillRect(0, 0, Canvas.width, Canvas.height);
            //Box
            Context.strokeStyle = '#000000';
            Context.strokeRect(1, 1, Canvas.width - 2, Canvas.height - 2);

            Context.fillStyle = "#000000";
            //Player
            if (Player.dx != 0 || Player.dy != 0) {
                if (Player.dx > 1) Player.dx = 1;
                if (Player.dy < -1) Player.dx = -1;
                if (Player.dy > 1) Player.dy = 1;
                if (Player.dy < -1) Player.dy = -1;
                var dx = Player.dx / Math.sqrt(Player.dx * Player.dx + Player.dy * Player.dy);
                var dy = Player.dy / Math.sqrt(Player.dx * Player.dx + Player.dy * Player.dy);
                Player.x += dx * Player.speed * deltaTime;
                Player.y += dy * Player.speed * deltaTime;
            }
            drawCircle(Player.x, Player.y, Player.size, 0, Math.PI * 2, true);

            //Cursor & Triangle
            Context.strokeStyle = '#000000';
            var cLeng = 5;
            Context.beginPath();
            Context.moveTo(Cursor.x + cLeng, Cursor.y);
            Context.lineTo(Cursor.x - cLeng, Cursor.y);
            Context.stroke();
            Context.moveTo(Cursor.x, Cursor.y + cLeng);
            Context.lineTo(Cursor.x, Cursor.y - cLeng);
            Context.stroke();
            Context.closePath();

            Context.fillStyle = "#FF0000";
            Player.angle = -Math.atan2((Cursor.y - Player.y), (Cursor.x - Player.x));
            console.log(Player.angle);
            var distPT = Player.size + Cursor.size;
            Context.beginPath();
            Context.moveTo(Player.x + distPT * Math.cos(Player.angle), Player.y - distPT * Math.sin(Player.angle));
            Context.lineTo(Player.x + (distPT - Cursor.size * Math.sqrt(3) / 2) * Math.cos(Player.angle) + (-Cursor.size / 2) * Math.sin(Player.angle), Player.y - (distPT - Cursor.size * Math.sqrt(3) / 2) * Math.sin(Player.angle) + (-Cursor.size / 2) * Math.cos(Player.angle));
            Context.lineTo(Player.x + (distPT - Cursor.size * Math.sqrt(3) / 2) * Math.cos(Player.angle) + (Cursor.size / 2) * Math.sin(Player.angle), Player.y - (distPT - Cursor.size * Math.sqrt(3) / 2) * Math.sin(Player.angle) + (Cursor.size / 2) * Math.cos(Player.angle));
            Context.closePath();
            Context.fill();

            Context.fillStyle = "#000000";
            //Enemy

            //Bullets
            ball = Ebullet[0];
            goSinbullet(ball);
            drawCircle(ball.x, ball.y, ball.size, 0, Math.PI * 2, true);

            //etc
            var ball;
            for (var i = 1; i < numBalls; i++)
            {
                ball = Ebullet[i];
                goReflectbullet(ball);
                drawCircle(ball.x, ball.y, ball.size, 0, Math.PI * 2, true);
            }

        }
        function goSinbullet(ball)
        {
            ball.speed = 20;
            ball.x += ball.speed * deltaTime;
            ball.y = ball.yunits + Math.sin(ball.bs * 0.1 * Math.PI) * 10;
            ball.bs += ball.speed * deltaTime;
            if(ball.x>Canvas.width-1||ball.y>Canvas.height-1)
            {
                ball.x = ball.xunits;
                ball.y = ball.yunits;
            }
        }
        function goReflectbullet(ball)
        {
            var radians = ball.angle * Math.PI / 180;
            ball.dx = Math.cos(radians);
            ball.dy = Math.sin(radians);

            ball.x += ball.dx * ball.speed * deltaTime;
            ball.y += ball.dy * ball.speed * deltaTime;
            if (ball.x > Canvas.width - ball.size || ball.x < ball.size) {
                ball.angle = 180 - ball.angle;
            }
            if (ball.y > Canvas.height - ball.size || ball.y < ball.size) {
                ball.angle = 360 - ball.angle;
            }
        }

        function onKeyDownFunc(e)
        {
            e.stopPropagation();
            //alert(Player.dy);
            if (e.keyCode == 87 && Player.dy > -1)   //W
            {
                Player.dy--;
                if (Player.dy == 0) setTimeout(onKeyDownFunc(e), 1);
            }
            if (e.keyCode == 65 && Player.dx > -1)    //A
            {
                Player.dx--;
                if (Player.dx == 0) setTimeout(onKeyDownFunc(e), 1);
            }
            if (e.keyCode == 83 && Player.dy < 1)   //S
            {
                Player.dy++;
                if (Player.dy == 0) setTimeout(onKeyDownFunc(e), 1);
            }
            if (e.keyCode == 68 && Player.dx < 1)   //D
            {
                Player.dx++;
                if (Player.dx == 0) setTimeout(onKeyDownFunc(e), 1);
            }
        }
        function onKeyUpFunc(e) {
            e.preventDefault();
            e.stopPropagation();
            //alert(e.keyCode);
            if (e.keyCode == 87 && Player.dy < 1)   //W
            {
                Player.dy = 0;
            }
            if (e.keyCode == 65 && Player.dx < 1)    //A
            {
                Player.dx = 0;
            }
            if (e.keyCode == 83 && Player.dy > -1)   //S
            {
                Player.dy = 0;
            }
            if (e.keyCode == 68 && Player.dx > -1)   //D
            {
                Player.dx = 0;
            }
        }
        function onMouseMoveFunc(e) {
            e.preventDefault();
            e.stopPropagation();

            var rect = Canvas.getBoundingClientRect();
            Cursor.x = e.clientX - rect.left;
            Cursor.y = e.clientY - rect.top;
        }

        function drawCircle(x, y, r, sa, ea, f) {
            Context.beginPath();
            Context.arc(x, y, r, sa, ea, true);
            Context.closePath();
            if (f == true) {
                Context.fill();
            }
            else {
                Context.stroke();
            }
        }
    }

    </script>

</head>
<body bgColor="black">
    <div id="container" style="position: absolute; top: 20px; left: 50px;">
        <canvas id="canvas" width="800" height="600">
            Your browser does not support the HTML 5 Canvas.
        </canvas>
    </div>
</body>
</html>