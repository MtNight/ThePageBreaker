<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<script type="text/javascript">
    window.addEventListener('load', init, false);
    function init()
    {
        //document.addEventListener('keypress', onKeyPressFunc(event), false);
        document.onkeydown = onKeyDownFunc;
        document.onkeyup = onKeyUpFunc;
        var Canvas = document.getElementById('canvas');
        var Context = Canvas.getContext('2d');
        var frame = 60;
        var deltaTime = 1 / frame;

        var Objects = new Array();
        var Player = { type: "player", x: 400, y: 300, angle: 0, speed: 50, size: 5, dx: 0, dy: 0 };
        var Enemies = new Array();
        var Pbullet = new Array();
        var Ebullet = new Array();

        Objects.push(Player);

        var numBalls = 10;
        var tempBall;
        var tempX;
        var tempY;
        var tempAngle;
        var tempRadians;
        var tempXunits;
        var tempYunits;
        var tempSize;
        var tempSpeed;

        for (var i = 0; i < numBalls; i++)
        {
            tempX = 30 + (Math.floor(Math.random() * Canvas.width) - 30);
            tempY = 30 + (Math.floor(Math.random() * Canvas.height) - 30);
            tempAngle = Math.floor(Math.random() * 360);
            tempRadians = tempAngle * Math.PI / 180;
            tempXunits = Math.cos(tempRadians);
            tempYunits = Math.sin(tempRadians);
            tempSize = Math.floor(Math.random() * 10 + 5);
            tempSpeed = Math.floor(Math.random() * 20 / tempSize) + 30;

            tempBall = { type: "etc", x: tempX, y: tempY, angle: tempAngle, xunits: tempXunits, yunits: tempYunits, size: tempSize, speed: tempSpeed }
            Objects.push(tempBall);
        }

        setInterval(update, deltaTime);
        function update()
        {
            draw();
            //collision
            //stat
        }

        function draw()
        {
            //Canvas
            Context.fillStyle = '#CCCCCC';
            Context.fillRect(0, 0, Canvas.width, Canvas.height);
            //Box
            Context.strokeStyle = '#000000';
            Context.strokeRect(1, 1, Canvas.width - 2, Canvas.height - 2);

            //Place balls
            Context.fillStyle = "#000000";
            var ball;

            for (var i = 0; i < Objects.length; i++)
            {
                ball = Objects[i];
                if (ball.type == "player")
                {
                    if (ball.dx != 0 || ball.dy != 0)
                    {
                        if (Player.dx > 1) Player.dx = 1;
                        if (Player.dy < -1) Player.dx = -1;
                        if (Player.dy > 1) Player.dy = 1;
                        if (Player.dy < -1) Player.dy = -1;
                        var dx = ball.dx / Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                        var dy = ball.dy / Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                        ball.x += dx * ball.speed * deltaTime;
                        ball.y += dy * ball.speed * deltaTime;
                    }
                    Context.beginPath();
                    Context.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2, true);
                    Context.closePath();
                    Context.fill();
                }
                else if (ball.type == "etc")
                {
                    ball.x += ball.xunits * ball.speed * deltaTime;
                    ball.y += ball.yunits * ball.speed * deltaTime;

                    Context.beginPath();
                    Context.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2, true);
                    Context.closePath();
                    Context.fill();

                    if (ball.x > Canvas.width || ball.x < 0) {
                        ball.angle = 180 - ball.angle;
                        updateBall(ball);
                    } else if (ball.y > Canvas.height || ball.y < 0) {
                        ball.angle = 360 - ball.angle;
                        updateBall(ball);
                    }
                }
            }
        }
        function updateBall(ball)
        {
            ball.radians = ball.angle * Math.PI / 180;
            ball.xunits = Math.cos(ball.radians);
            ball.yunits = Math.sin(ball.radians);
        }

        function onKeyDownFunc(e)
        {
            e.stopPropagation();
            //alert(Player.dy);
            if (e.keyCode == 87 && Player.dy > -1)   //W
            {
                Player.dy--;
                if (Player.dy == 0) setTimeout(onKeyDownFunc(e), 1);
            }
            if (e.keyCode == 65 && Player.dx > -1)    //A
            {
                Player.dx--;
                if (Player.dx == 0) setTimeout(onKeyDownFunc(e), 1);
            }
            if (e.keyCode == 83 && Player.dy < 1)   //S
            {
                Player.dy++;
                if (Player.dy == 0) setTimeout(onKeyDownFunc(e), 1);
            }
            if (e.keyCode == 68 && Player.dx < 1)   //D
            {
                Player.dx++;
                if (Player.dx == 0) setTimeout(onKeyDownFunc(e), 1);
            }
        }
        function onKeyUpFunc(e) {
            e.preventDefault();
            e.stopPropagation();
            //alert(e.keyCode);
            if (e.keyCode == 87 && Player.dy < 1)   //W
            {
                Player.dy = 0;
            }
            if (e.keyCode == 65 && Player.dx < 1)    //A
            {
                Player.dx = 0;
            }
            if (e.keyCode == 83 && Player.dy > -1)   //S
            {
                Player.dy = 0;
            }
            if (e.keyCode == 68 && Player.dx > -1)   //D
            {
                Player.dx = 0;
            }
        }
    }
</script>

</head>
<body bgColor="black">
    <div style="position: absolute; top: 50px; left: 50px;">
        <canvas id="canvas" width="800" height="600">
            Your browser does not support the HTML 5 Canvas.
        </canvas>
    </div>
</body>
</html>
